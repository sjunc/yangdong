<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>STT / TTS 샘플</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 20px; line-height: 1.45; }
    h1 { margin-bottom: 0; }
    small { color: #666; }
    section { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 16px 0; }
    label { display: block; margin: 8px 0 4px; font-weight: 600; }
    input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 14px; border: 0; border-radius: 10px; background: #111827; color: #fff; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .pill { display:inline-block; background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; }
    .muted { color:#6b7280; }
    audio { width: 100%; margin-top: 8px; }
    pre { background:#f9fafb; padding:12px; border-radius:8px; overflow:auto; }
  </style>
</head>
<body>
  <h1>STT / TTS 샘플</h1>
  <small>로컬 FastAPI(9000) ↔ OpenAI GPT-4o-mini</small>

  <!-- 헬스 -->
  <section>
    <div class="row">
      <button id="btnHealth">헬스 체크</button>
      <span id="healthOut" class="mono muted"></span>
    </div>
  </section>

  <!-- STT -->
  <section>
    <h2>STT: 음성 → 텍스트</h2>
    <label>음성 파일 업로드 (wav/mp3/m4a 등)</label>
    <input type="file" id="sttFile" accept="audio/*" />
    <div class="row">
      <button id="btnStt">변환</button>
      <span class="pill">POST /stt</span>
    </div>
    <h3>결과</h3>
    <div><strong>text:</strong> <span id="sttText" class="mono"></span></div>
    <div class="muted" id="sttLang"></div>
    <details style="margin-top:8px;">
      <summary>segments</summary>
      <pre id="sttSegs"></pre>
    </details>
  </section>

  <!-- TTS -->
  <section>
    <h2>TTS: 텍스트 → 음성</h2>
    <label>텍스트</label>
    <textarea id="ttsText" rows="3" placeholder="여기에 텍스트를 입력하세요."></textarea>
    <div class="row">
      <button id="btnTts">합성</button>
      <span class="pill">POST /tts</span>
    </div>
    <h3>오디오</h3>
    <audio id="ttsAudio" controls></audio>
    <div class="row">
      <button id="btnTtsDownload" disabled>MP3 다운로드</button>
      <span id="ttsSize" class="muted"></span>
    </div>
  </section>

  <!-- Voice Chat -->
  <section>
    <h2>Voice Chat: 음성 → (STT) → (LLM) → (TTS)</h2>
    <label>음성 파일 업로드</label>
    <input type="file" id="vcFile" accept="audio/*" />
    <div class="row">
      <button id="btnVoiceChat">대화</button>
      <span class="pill">POST /voice-chat</span>
    </div>
    <h3>결과</h3>
    <div><strong>사용자 인식:</strong> <span id="vcUser" class="mono"></span></div>
    <div><strong>모델 답변:</strong> <span id="vcAnswer" class="mono"></span></div>
    <audio id="vcAudio" controls></audio>
  </section>

  <script>
    const $ = (q) => document.querySelector(q);

    function b64ToBlob(b64, mime) {
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
      return new Blob([bytes], { type: mime });
    }

    // ----- 헬스 -----
    $("#btnHealth").onclick = async () => {
      $("#btnHealth").disabled = true;
      $("#healthOut").textContent = "checking...";
      try {
        const r = await fetch("/health");
        const j = await r.json();
        $("#healthOut").textContent = JSON.stringify(j);
      } catch (e) {
        $("#healthOut").textContent = "error: " + e;
      } finally {
        $("#btnHealth").disabled = false;
      }
    };

    // ----- STT -----
    $("#btnStt").onclick = async () => {
      const f = $("#sttFile").files?.[0];
      if (!f) return alert("파일을 선택하세요.");
      $("#btnStt").disabled = true;

      try {
        const fd = new FormData();
        fd.append("file", f);
        const r = await fetch("/stt", { method: "POST", body: fd });
        if (!r.ok) throw new Error(await r.text());
        const j = await r.json();
        $("#sttText").textContent = j.text || "";
        $("#sttLang").textContent = "language: " + (j.language || "unknown");
        $("#sttSegs").textContent = JSON.stringify(j.segments || [], null, 2);
      } catch (e) {
        alert("STT 오류: " + e);
      } finally {
        $("#btnStt").disabled = false;
      }
    };

    // ----- TTS -----
    let lastTtsBlobUrl = null;
    $("#btnTts").onclick = async () => {
      const text = $("#ttsText").value.trim();
      if (!text) return alert("텍스트를 입력하세요.");
      $("#btnTts").disabled = true;

      try {
        const r = await fetch("/tts", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });
        const raw = await r.text();
        if (!r.ok) throw new Error(raw);
        const j = JSON.parse(raw);

        if (!j.audio_b64) throw new Error("응답에 오디오 데이터 없음");
        const blob = b64ToBlob(j.audio_b64, j.mime || "audio/mpeg");

        if (lastTtsBlobUrl) URL.revokeObjectURL(lastTtsBlobUrl);
        lastTtsBlobUrl = URL.createObjectURL(blob);
        $("#ttsAudio").src = lastTtsBlobUrl;
        $("#ttsAudio").play().catch(()=>{});

        $("#btnTtsDownload").disabled = false;
        $("#btnTtsDownload").onclick = () => {
          const a = document.createElement("a");
          a.href = lastTtsBlobUrl;
          a.download = "tts_output.mp3";
          a.click();
        };
        $("#ttsSize").textContent = `size: ${(blob.size/1024).toFixed(1)} KB`;
      } catch (e) {
        alert("TTS 오류: " + e);
      } finally {
        $("#btnTts").disabled = false;
      }
    };

    // ----- Voice Chat -----
    $("#btnVoiceChat").onclick = async () => {
      const f = $("#vcFile").files?.[0];
      if (!f) return alert("파일을 선택하세요.");
      $("#btnVoiceChat").disabled = true;

      try {
        const fd = new FormData();
        fd.append("file", f);
        const r = await fetch("/voice-chat", { method: "POST", body: fd });
        const raw = await r.text();
        if (!r.ok) throw new Error(raw);
        const j = JSON.parse(raw);

        $("#vcUser").textContent = j.user_text || "";
        $("#vcAnswer").textContent = j.assistant_text || "";

        if (j.audio_b64) {
          const blob = b64ToBlob(j.audio_b64, j.audio_mime || "audio/mpeg");
          const url = URL.createObjectURL(blob);
          $("#vcAudio").src = url;
          $("#vcAudio").play().catch(()=>{});
        }
      } catch (e) {
        alert("Voice Chat 오류: " + e);
      } finally {
        $("#btnVoiceChat").disabled = false;
      }
    };
  </script>

  <!-- RAG 테스트 UI -->
  <section>
    <h2>RAG: 학칙 질문</h2>
    <label>질문</label>
    <input type="text" id="ragQ" placeholder="예: 휴학은 최대 몇 학기?"/>
    <div class="row">
      <button id="btnRagAsk">질문</button>
      <span class="pill">POST /rag/chat</span>
    </div>
    <h3>답변</h3>
    <pre id="ragAns"></pre>
  </section>

  <script>
    $("#btnRagAsk").onclick = async () => {
      const q = $("#ragQ").value.trim();
      if (!q) return alert("질문을 입력하세요.");
      const r = await fetch("/rag/chat", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({query: q, top_k: 4})
      });
      const raw = await r.text();
      if (!r.ok) return alert("RAG 오류: " + raw);
      const j = JSON.parse(raw);
      $("#ragAns").textContent = j.answer + "\n\nsources: " + JSON.stringify(j.sources);
    };
  </script>

</body>
</html>
